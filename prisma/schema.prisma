generator client {
  provider = "prisma-client"
  output   = "./generated"
}

datasource db {
  provider = "postgresql"
}

enum Role {
  USER
  ADMIN
  SUPER_ADMIN
}

enum OrganizationRole {
  OWNER
  ADMIN
  MEMBER
  GUEST
}

enum AuditEvent {
  LOGIN_SUCCESS
  LOGIN_FAILED
  LOGOUT
  PASSWORD_CHANGED
  PASSWORD_RESET_REQUESTED
  PASSWORD_RESET_COMPLETED
  EMAIL_VERIFIED
  OAUTH_CONNECTED
  OAUTH_DISCONNECTED
  ROLE_CHANGED
  ACCOUNT_LOCKED
  ACCOUNT_UNLOCKED
  SUSPICIOUS_ACTIVITY
  TWO_FACTOR_ENABLED
  TWO_FACTOR_DISABLED
}

enum AuditStatus {
  SUCCESS
  FAILED
  PENDING
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String
  password      String?
  emailVerified Boolean   @default(false)
  image         String?
  role          Role      @default(USER)
  banned        Boolean   @default(false)

  // Onboarding
  onboardingCompleted Boolean @default(false)
  onboardingSteps     Json?
  bio                 String?
  company             String?
  useCase             String?
  emailNotifications  Boolean   @default(true)

  accounts                Account[]
  sessions                Session[]
  impersonationsPerformed ImpersonationLog[] @relation("ImpersonationsByAdmin")
  impersonationsReceived  ImpersonationLog[] @relation("ImpersonationsOfUser")
  organizationMembers     OrganizationMember[]
  sentInvites             OrganizationInvite[] @relation("SentInvites")
  createdTodos            Todo[]               @relation("TodosCreated")
  auditLogs               AuditLog[]

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@map("users")
}

model Account {
  id                    String    @id @default(cuid())
  accountId             String
  providerId            String
  userId                String
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("accounts")
}

model Session {
  id                    String   @id @default(cuid())
  expiresAt             DateTime
  token                 String   @unique
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  ipAddress             String?
  userAgent             String?
  userId                String
  impersonatedBy        String?
  currentOrganizationId String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model Verification {
  id         String   @id @default(cuid())
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map("verifications")
}



model ImpersonationLog {
  id           String    @id @default(cuid())
  adminId      String
  targetUserId String
  startedAt    DateTime  @default(now())
  endedAt      DateTime?
  reason       String?
  ipAddress    String?
  userAgent    String?

  admin      User @relation("ImpersonationsByAdmin", fields: [adminId], references: [id], onDelete: Cascade)
  targetUser User @relation("ImpersonationsOfUser", fields: [targetUserId], references: [id], onDelete: Cascade)

  @@index([adminId])
  @@index([targetUserId])
  @@index([startedAt])
  @@map("impersonation_logs")
}

model AuditLog {
  id        String      @id @default(cuid())
  userId    String?
  email     String?
  event     AuditEvent
  status    AuditStatus
  metadata  Json?
  ipAddress String
  userAgent String
  createdAt DateTime    @default(now())

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([event])
  @@index([createdAt])
  @@map("audit_logs")
}

model Todo {
  id             String       @id @default(cuid())
  title          String
  description    String?
  completed      Boolean      @default(false)
  organizationId String
  createdBy      String

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  creator      User         @relation("TodosCreated", fields: [createdBy], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId])
  @@index([createdBy])
  @@index([completed])
  @@map("todos")
}

model Organization {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  description String?
  image       String?
  planType    String   @default("free")

  members OrganizationMember[]
  invites OrganizationInvite[]
  todos   Todo[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("organizations")
}

model OrganizationMember {
  id             String           @id @default(cuid())
  userId         String
  organizationId String
  role           OrganizationRole @default(MEMBER)

  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, organizationId])
  @@index([userId])
  @@index([organizationId])
  @@map("organization_members")
}

model OrganizationInvite {
  id             String           @id @default(cuid())
  email          String
  organizationId String
  invitedById    String?
  role           OrganizationRole @default(MEMBER)
  token          String           @unique
  expiresAt      DateTime
  acceptedAt     DateTime?

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  invitedBy    User?        @relation("SentInvites", fields: [invitedById], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
  @@index([organizationId])
  @@index([token])
  @@index([invitedById])
  @@map("organization_invites")
}
